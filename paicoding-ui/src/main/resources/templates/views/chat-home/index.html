<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<div th:replace="components/layout/header :: head(~{::title}, ~{}, ~{})">
    <title th:text="${global.siteInfo.websiteName}">
        派聪明 | 技术派
    </title>
</div>

<link rel="stylesheet" href="/css/views/chat-home.css"/>

<body id="body">
<!-- 导航栏 -->
<div th:replace="components/layout/navbar :: navbar"></div>
<div class="custom-home">
    <div class="chat-wrap">
        <div class="chat-sidebar">
            <div class="home_sidebar-header__b5asC">
                <div class="home_sidebar-title__d8_c_">派聪明</div>
                <div class="home_sidebar-sub-title__IS2Or">
                    嗨，我超聪明的，能够学习和理解你的意思，进行多轮对话。
                    并回答问题，高效便捷地帮助你获取信息、完成任务。
                </div>
                <div class="home_sidebar-logo__FFdBS no-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="43" height="44" fill="none"><defs><path id="chatgpt_svg__a" d="M0 0h43v43.58H0z"></path></defs><g><mask id="chatgpt_svg__b" fill="#fff"><use xlink:href="#chatgpt_svg__a"></use></mask><g mask="url(#chatgpt_svg__b)"><path fill-rule="evenodd" opacity="0.27" d="M40.17 17.84c.36-1.11.55-2.27.55-3.43 0-1.93-.51-3.83-1.49-5.49a10.98 10.98 0 0 0-9.52-5.51c-.77 0-1.55.08-2.3.24A10.868 10.868 0 0 0 19.29 0h-.1c-4.76 0-8.98 3.07-10.45 7.6-3.06.63-5.71 2.55-7.26 5.27a10.993 10.993 0 0 0 1.35 12.87c-.36 1.11-.55 2.27-.55 3.43 0 1.93.51 3.83 1.49 5.49a10.97 10.97 0 0 0 11.82 5.27c2.06 2.32 5.02 3.65 8.12 3.65h.1c4.76 0 8.99-3.07 10.45-7.61a10.82 10.82 0 0 0 7.26-5.26 10.995 10.995 0 0 0-1.35-12.87ZM18.817 38.695c-.09.05-.17.1-.26.15a8.145 8.145 0 0 0 5.22 1.89h.01c4.5-.01 8.15-3.67 8.16-8.17v-10.13a.153.153 0 0 0-.07-.1l-3.67-2.12v12.24c0 .51-.27.98-.72 1.23l-8.67 5.01Zm-1.424-2.472 8.77-5.06c.04-.03.06-.07.06-.11h-.01v-4.24l-10.59 6.12c-.44.25-.98.25-1.42 0l-8.68-5.01c-.08-.05-.2-.12-.26-.16a8.19 8.19 0 0 0 .97 5.47 8.18 8.18 0 0 0 7.08 4.08c1.43 0 2.84-.37 4.08-1.09Zm-9.187-25.21v-.3c-1.79.66-3.3 1.93-4.25 3.58a8.226 8.226 0 0 0-1.09 4.08c0 2.92 1.55 5.61 4.08 7.07l8.77 5.07c.04.02.09.02.12-.01l3.67-2.12-10.59-6.11c-.44-.25-.71-.72-.71-1.23v-10.03Zm27.849 7.117-8.77-5.07a.126.126 0 0 0-.12.01l-3.67 2.12 10.59 6.12c.44.25.71.71.71 1.22v10.33a8.168 8.168 0 0 0 5.35-7.66 8.16 8.16 0 0 0-4.09-7.07Zm-19.22-5.718a.16.16 0 0 0-.05.11v4.24l10.59-6.12c.22-.12.47-.19.72-.19s.49.07.71.19l8.68 5.02c.08.05.17.1.25.15.08-.46.12-.92.12-1.38 0-4.51-3.66-8.17-8.17-8.17-1.43 0-2.83.38-4.08 1.09l-8.77 5.06ZM19.22 2.85c-4.51 0-8.17 3.65-8.17 8.16v10.13c.01.05.03.08.07.1l3.67 2.12.01-12.23v-.01c0-.5.27-.97.71-1.22l8.68-5.01c.07-.05.19-.11.25-.15a8.145 8.145 0 0 0-5.22-1.89ZM16.783 24.51l4.72 2.73 4.72-2.73v-5.45l-4.72-2.72-4.72 2.73v5.44Z" style="fill: var(--pai-brand-1-normal);"></path></g></g></svg>
                </div>
            </div>
            <div class="login-guide-wrap" th:if="${!global.isLogin}">
                <div class="home_sidebar-title__d8_c_">加入星球后可立即获得以下权益</div>
                <ul  class="login-guide-list">
                    <li  class="login-guide-list-item">
                        <div  class="login-guide-icon-wrap">
                            <svg  width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg" class="login-guide-icon"><path  fill-rule="evenodd" clip-rule="evenodd" d="M13.2368 3.03451C12.587 2.18471 11.3966 2.05398 10.5779 2.74252L8.99865 4.07065L7.41943 2.74252C6.60071 2.05398 5.41026 2.18471 4.76048 3.03451C4.40851 3.49484 4.28737 4.07174 4.38041 4.61328H3.42708C2.6907 4.61328 2.09375 5.21023 2.09375 5.94661V7.78026C2.09375 8.50852 2.67761 9.10041 3.40278 9.11338V14.285C3.40278 15.3896 4.29821 16.285 5.40278 16.285H12.5945C13.6991 16.285 14.5945 15.3896 14.5945 14.285V9.11342C15.3209 9.10187 15.9062 8.50942 15.9062 7.78026V5.94661C15.9062 5.21024 15.3093 4.61328 14.5729 4.61328H13.6169C13.7099 4.07174 13.5888 3.49484 13.2368 3.03451ZM12.61 4.61328C12.7209 4.3068 12.6796 3.95035 12.4715 3.67815C12.1572 3.26708 11.5813 3.20384 11.1853 3.53691L9.90541 4.61328H12.61ZM8.09189 4.61328L6.81202 3.53691C6.41598 3.20384 5.84013 3.26708 5.52581 3.67815C5.31768 3.95035 5.27642 4.3068 5.38727 4.61328H8.09189ZM3.09375 5.94661C3.09375 5.76252 3.24299 5.61328 3.42708 5.61328H8.49863V8.11359H3.42708C3.24299 8.11359 3.09375 7.96435 3.09375 7.78026V5.94661ZM9.49863 8.11359V5.61328H14.5729C14.757 5.61328 14.9062 5.76252 14.9062 5.94661V7.78026C14.9062 7.96435 14.757 8.11359 14.5729 8.11359H9.49863ZM4.40278 9.11719H8.49863L8.49863 15.285H5.40278C4.85049 15.285 4.40278 14.8373 4.40278 14.285V9.11719ZM9.49863 9.11719L9.49863 15.285H12.5945C13.1468 15.285 13.5945 14.8373 13.5945 14.285V9.11719H9.49863Z" fill="currentColor"></path>
                            </svg>
                        </div>
                        <span  class="login-guide-text">畅玩派聪明，每月省去 20刀</span>
                    </li>
                    <li  class="login-guide-list-item">
                        <div  class="login-guide-icon-wrap">
                            <svg  width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" class="login-guide-icon"><path  d="M4.62218 2.68165C3.64897 2.29236 2.59033 3.0091 2.59033 4.05728V13.961C2.59033 14.2639 2.77476 14.5363 3.05601 14.6488L8.88416 16.98C9.59939 17.2661 10.3973 17.2661 11.1125 16.98L16.9406 14.6488C17.2219 14.5363 17.4063 14.2639 17.4063 13.961V4.05728C17.4063 3.0091 16.3477 2.29236 15.3745 2.68165L11.1125 4.38644C10.3973 4.67253 9.59939 4.67253 8.88416 4.38644L4.62218 2.68165Z" stroke="currentColor" stroke-width="1.2"></path><path  d="M9.99609 7.42676V14.094" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"></path>
                            </svg>
                        </div>
                        <span  class="login-guide-text">精心打造的面试攻略，为你的求职报价护航</span>
                    </li>
                    <li  class="login-guide-list-item">
                        <div  class="login-guide-icon-wrap">
                            <svg  width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg" class="login-guide-icon"><path  fill-rule="evenodd" clip-rule="evenodd" d="M12.1337 10.5801C12.4205 10.5801 12.653 10.8125 12.653 11.0993V11.8658H13.4194C13.7062 11.8658 13.9387 12.0983 13.9387 12.385C13.9387 12.6718 13.7062 12.9043 13.4194 12.9043H12.1337C11.847 12.9043 11.6145 12.6718 11.6145 12.385V11.0993C11.6145 10.8125 11.847 10.5801 12.1337 10.5801Z" fill="currentColor"></path><path  fill-rule="evenodd" clip-rule="evenodd" d="M2.05225 4.64889C2.05225 3.21507 3.21458 2.05273 4.6484 2.05273H11.4231C12.8569 2.05273 14.0193 3.21507 14.0193 4.64889V9.32197H12.9808V4.64889C12.9808 3.7886 12.2834 3.0912 11.4231 3.0912H4.6484C3.78811 3.0912 3.09071 3.7886 3.09071 4.64889V13.3522C3.09071 14.2125 3.78811 14.9099 4.6484 14.9099H12.2143V15.9483H4.6484C3.21459 15.9483 2.05225 14.786 2.05225 13.3522V4.64889Z" fill="currentColor"></path><path  fill-rule="evenodd" clip-rule="evenodd" d="M12.214 9.51893C10.7255 9.51893 9.51893 10.7255 9.51893 12.214C9.51893 13.7024 10.7255 14.909 12.214 14.909C13.7024 14.909 14.909 13.7024 14.909 12.214C14.909 10.7255 13.7024 9.51893 12.214 9.51893ZM8.48047 12.214C8.48047 10.152 10.152 8.48047 12.214 8.48047C14.2759 8.48047 15.9475 10.152 15.9475 12.214C15.9475 14.2759 14.2759 15.9475 12.214 15.9475C10.152 15.9475 8.48047 14.2759 8.48047 12.214Z" fill="currentColor"></path><path  fill-rule="evenodd" clip-rule="evenodd" d="M4.82129 5.4372C4.82129 5.15044 5.05376 4.91797 5.34052 4.91797L10.7306 4.91797C11.0174 4.91797 11.2499 5.15044 11.2499 5.4372C11.2499 5.72396 11.0174 5.95643 10.7306 5.95643L5.34052 5.95643C5.05376 5.95643 4.82129 5.72396 4.82129 5.4372Z" fill="currentColor"></path><path  fill-rule="evenodd" clip-rule="evenodd" d="M4.78394 8.35712C4.78394 8.07035 5.01641 7.83789 5.30317 7.83789L8.03531 7.83791C8.32208 7.83791 8.55454 8.07038 8.55454 8.35715C8.55454 8.64391 8.32207 8.87637 8.03531 8.87637L5.30316 8.87635C5.0164 8.87635 4.78393 8.64388 4.78394 8.35712Z" fill="currentColor"></path>
                            </svg>
                        </div>
                        <span  class="login-guide-text">提升编程实战项目，附技术派120篇详细教程</span>
                    </li>
                    <li  class="login-guide-list-item">
                        <div  class="login-guide-icon-wrap">
                            <svg  width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg" class="login-guide-icon"><path  fill-rule="evenodd" clip-rule="evenodd" d="M8.99999 3.37781L7.26101 6.9014C7.15913 7.10768 6.96219 7.25119 6.73392 7.28433L2.84544 7.84938L5.65897 10.5919C5.65903 10.592 5.6589 10.5919 5.65897 10.5919C5.82418 10.7529 5.89936 10.9849 5.8605 11.2116L5.19624 15.0845L8.67423 13.256C8.87818 13.1488 9.12181 13.1488 9.32576 13.256L12.8037 15.0845L12.1395 11.2117C12.1006 10.9849 12.1756 10.7531 12.3408 10.5921C12.3409 10.592 12.3408 10.5922 12.3408 10.5921L15.1545 7.84938L11.2663 7.28437C11.038 7.25122 10.8409 7.10782 10.739 6.90153L8.99999 3.37781ZM9.26883 2.83308C9.26888 2.83298 9.26878 2.83318 9.26883 2.83308V2.83308ZM9.62775 2.39022C9.37097 1.86993 8.62901 1.86993 8.37224 2.39022L6.43408 6.3174L2.10014 6.94718C1.52608 7.03061 1.29661 7.73615 1.71217 8.14119C1.71216 8.14118 1.71219 8.14121 1.71217 8.14119L4.84822 11.1981L4.10789 15.5145C4.00989 16.0863 4.61 16.5224 5.12357 16.2525L8.99999 14.2145L12.8764 16.2525C13.3899 16.5224 13.9901 16.0863 13.8921 15.5146L13.1518 11.1981L16.2877 8.14126C16.7035 7.73618 16.4739 7.0306 15.8999 6.94718L11.5659 6.3174L9.62775 2.39022ZM4.96134 11.3084C4.96141 11.3084 4.96128 11.3083 4.96134 11.3084V11.3084Z" fill="currentColor"></path>
                            </svg>
                        </div>
                        <span  class="login-guide-text">简历指导，拿下HR的芳心</span>
                    </li>

                    <li  class="login-guide-list-item">
                        <div  class="login-guide-icon-wrap">
                            <svg  width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg" class="login-guide-icon"><path  fill-rule="evenodd" clip-rule="evenodd" d="M5.21627 3.23729H2.91894L2.91894 14.2645H5.21627V3.23729ZM2.91894 2.31836C2.41142 2.31836 2 2.72978 2 3.23729V14.2645C2 14.772 2.41142 15.1835 2.91894 15.1835H5.21627C5.72379 15.1835 6.13521 14.772 6.13521 14.2645V3.23729C6.13521 2.72978 5.72379 2.31836 5.21627 2.31836H2.91894Z" fill="currentColor"></path><path  fill-rule="evenodd" clip-rule="evenodd" d="M8.43258 3.23729H6.13524L6.13524 14.2645H8.43258V3.23729ZM6.13524 2.31836C5.62773 2.31836 5.21631 2.72978 5.21631 3.23729V14.2645C5.21631 14.772 5.62773 15.1835 6.13524 15.1835H8.43258C8.9401 15.1835 9.35152 14.772 9.35152 14.2645V3.23729C9.35152 2.72978 8.9401 2.31836 8.43258 2.31836H6.13524Z" fill="currentColor"></path><path  fill-rule="evenodd" clip-rule="evenodd" d="M12.0205 3.1255L9.80149 3.7201L12.6555 14.3716L14.8746 13.777L12.0205 3.1255ZM9.56365 2.83247C9.07343 2.96383 8.78251 3.46772 8.91386 3.95794L11.7679 14.6094C11.8993 15.0996 12.4032 15.3906 12.8934 15.2592L15.1124 14.6646C15.6027 14.5333 15.8936 14.0294 15.7622 13.5391L12.9082 2.88767C12.7768 2.39744 12.2729 2.10653 11.7827 2.23788L9.56365 2.83247Z" fill="currentColor"></path>
                            </svg>
                        </div>
                        <span  class="login-guide-text">面渣逆袭 PDF，让天下没有难刷的八股文</span>
                    </li>
                    <li  class="login-guide-list-item">
                        <div  class="login-guide-icon-wrap">
                            <svg  width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg" class="user-level-icon login-guide-icon"><path  d="M17.2673 10.1562H19.7673V12.6562" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path  d="M8.5625 8.25V18.375C8.5625 18.9273 9.01022 19.375 9.5625 19.375H20.4375" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path  d="M10.5625 16.0938L13.888 12.36L16.0216 14.2603L18.9739 10.9455" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                            </svg>
                        </div>
                        <span  class="login-guide-text">向二哥提问、制定学习计划、告别迷茫和焦虑</span>
                    </li>
                </ul>
                <!-- 立即登录 button -->
                <a th:href="${global.siteInfo.zsxqUrl}" target="_blank" rel="nofollow noopener noreferrer">
                    <img th:src="${global.siteInfo.zsxqPosterUrl}">
                </a>
            </div>
        </div>

        <div class="chat-main">
            <div class="window-header">
                <div class="window-header-title">
                    <div class="window-header-main-title home_chat-body-title__5S8w4"
                         th:data-target="${global.isLogin ? '' : '#registerModal'}"
                         th:data-toggle="${global.isLogin ? '' : 'modal'}"
                    >点击绑定星球顺带登录</div>
                    <div class="window-header-sub-title">与派聪明的 0 条对话</div>
                </div>
            </div>
            <div class="chat-display">
                <div class="chat-message">
                    <div class="message-content" id="chat-content">
                    </div>
                </div>
            </div>

            <div class="chat-input">
                <textarea id="input-field" class="form-control" rows="3" placeholder="你好，我是派聪明，快登录和我对线吧" disabled></textarea>
                <button id="send-btn" disabled>
                    <div class="button_icon-button-icon__qlUH3 no-dark">
                        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="16" height="16" fill="none"><defs><path id="send-white_svg__a" d="M0 0h16v16H0z"></path></defs><g><mask id="send-white_svg__b" fill="#fff"><use xlink:href="#send-white_svg__a"></use></mask><g mask="url(#send-white_svg__b)"><path transform="translate(1.333 2)" d="M0 4.71 6.67 6l1.67 6.67L12.67 0 0 4.71Z" style="stroke: rgb(255, 255, 255); stroke-width: 1.33333; stroke-opacity: 1; stroke-dasharray: 0, 0;"></path><path transform="translate(8.003 6.117)" d="M0 1.89 1.89 0" style="stroke: rgb(255, 255, 255); stroke-width: 1.33333; stroke-opacity: 1; stroke-dasharray: 0, 0;"></path></g></g></svg>
                    </div>
                    <div class="button_icon-button-text__k3vob">等待登录</div>
                </button>
            </div>
        </div>
    </div>
    <!-- 底部信息 -->
    <div th:replace="components/layout/footer :: footer"></div>
</div>
</body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.5/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<script th:inline="javascript">
    let ws = null;
    const inputField = $("#input-field");
    const sendBtn = $("#send-btn"), sendBtnText = $(".button_icon-button-text__k3vob");
    const chatContent = $("#chat-content");
    // 用户名
    const chatTitle = $(".window-header-main-title");

    // 从 global.user.photo 中取出用户头像 thymeleaf 传入的值
    const isLogin = [[${global.isLogin}]], user = [[${global.user}]];

    // 页面加载完成后，执行 initWs
    $(function () {
        if (isLogin) {
            initWs();
        } else {
            console.log("请先登录");
        }
    });

    function initWs() {
        // 建立会话
        ws = new WebSocket("ws://localhost:8080/chatgpt");
        ws.onopen = function () {
            // 建立连接
            console.log("ws连接成功");
            inputField.removeAttr("disabled");
            // 改变 inputField 的 placeholder
            inputField.attr("placeholder", "可按回车发送");
            sendBtnText.text("发送");
            sendBtn.removeAttr("disabled");
            // 改变 chatTitle 的内容
            chatTitle.text(user.userName);
        }

        ws.onmessage = function (message) {
            // 解析 JSON 字符串
            const data = JSON.parse(message.data);
            const msg = data.message;
            // type 转为 number 类型
            const type = Number(data.type);

            // 打印到控制台
            console.log("接受消息: " + msg);
            console.log("接收时间: " + data.time);
            console.log("接收类型: " + data.type);

            if (type === 1) {
                // 把 home_chat-message-actions__loading 的元素移除，不再显示 loading
                $(".home_chat-message-actions__loading").remove();

                appendServerMessage(msg, data.time);
            } else if (type === 0) {
                console.log("连接成功")
                appendServerMessage(msg, data.time);
            }

            // 添加完消息后，恢复按钮的状态
            sendBtn.removeAttr("disabled");
        }

        ws.onclose = function (e) {
            console.log("ws中断");
            ws = null;
            // 提醒用户重新连接
            inputField.attr("disabled", "disabled").val("连接中断，点击右侧按钮重连");
            sendBtn.removeAttr("disabled");
            sendBtnText.text("重连");
        }
    }

    // 添加服务器端消息
    function appendServerMessage(content, time) {
        let serverMsg = `
            <div class="home_chat-message__rdH_g">
                <div class="home_chat-message-container__plj_e">
                    <div class="home_chat-message-avatar__611lI">
                        <div class="no-dark">
                            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35" fill="none">
                                <defs><path id="bot_svg__a" d="M0 0h30v30H0z"></path><path id="bot_svg__c" d="M0 0h20.455v20.455H0z"></path></defs><g><rect fill="var(--pai-bg-normal-1)" width="30" height="30" rx="10"></rect><mask id="bot_svg__b" fill="#fff"><use xlink:href="#bot_svg__a"></use></mask><g mask="url(#bot_svg__b)"><g transform="translate(4.773 4.773)"><mask id="bot_svg__d" fill="#fff"><use xlink:href="#bot_svg__c"></use></mask><g mask="url(#bot_svg__d)"><path fill-rule="evenodd" d="M19.11 8.37c.17-.52.26-1.06.26-1.61 0-.9-.24-1.79-.71-2.57a5.24 5.24 0 0 0-4.53-2.59c-.37 0-.73.04-1.09.11A5.201 5.201 0 0 0 9.17 0h-.04C6.86 0 4.86 1.44 4.16 3.57A5.11 5.11 0 0 0 .71 6.04C.24 6.83 0 7.72 0 8.63c0 1.27.48 2.51 1.35 3.45-.18.52-.27 1.07-.27 1.61 0 .91.25 1.8.71 2.58 1.13 1.94 3.41 2.94 5.63 2.47a5.18 5.18 0 0 0 3.86 1.71h.05c2.26 0 4.27-1.44 4.97-3.57a5.132 5.132 0 0 0 3.45-2.47c.46-.78.7-1.67.7-2.58 0-1.28-.48-2.51-1.34-3.46ZM8.947 18.158c-.04.03-.08.05-.12.07.7.58 1.57.89 2.48.89h.01c2.14 0 3.88-1.72 3.88-3.83v-4.76c0-.02-.02-.04-.04-.05l-1.74-.99v5.75c0 .23-.13.45-.34.57l-4.13 2.35Zm-.67-1.153 4.17-2.38c.02-.01.03-.03.03-.05v-1.99l-5.04 2.87c-.21.12-.47.12-.68 0l-4.13-2.35c-.04-.02-.09-.06-.12-.07-.04.21-.06.43-.06.65 0 .67.18 1.33.52 1.92v-.01c.7 1.19 1.98 1.92 3.37 1.92.68 0 1.35-.18 1.94-.51ZM3.903 5.168v-.14c-.85.31-1.57.9-2.02 1.68a3.78 3.78 0 0 0-.52 1.91c0 1.37.74 2.64 1.94 3.33l4.17 2.37c.02.01.04.01.06 0l1.75-1-5.04-2.87a.64.64 0 0 1-.34-.57v-4.71Zm13.253 3.337-4.18-2.38c-.02 0-.04 0-.06.01l-1.74.99 5.04 2.87c.21.12.34.34.34.58v4.85c1.52-.56 2.54-1.99 2.54-3.6 0-1.37-.74-2.63-1.94-3.32ZM8.014 5.83c-.02.01-.03.03-.03.05v1.99L13.024 5a.692.692 0 0 1 .68 0l4.13 2.35c.04.02.08.05.12.07.03-.21.05-.43.05-.65 0-2.11-1.74-3.83-3.88-3.83-.68 0-1.35.18-1.94.51l-4.17 2.38Zm1.133-4.492c-2.15 0-3.89 1.72-3.89 3.83v4.76c0 .02.02.03.03.04l1.75 1v-5.75c0-.23.13-.45.34-.57l4.13-2.35c.04-.03.09-.06.12-.07-.7-.58-1.58-.89-2.48-.89ZM7.983 11.51l2.24 1.27 2.25-1.27V8.95l-2.25-1.28-2.24 1.28v2.56Z" style="fill: var(--pai-brand-1-normal);"></path></g></g></g></g>
                            </svg>
                        </div>
                    </div>
                    <div class="home_chat-message-item__hDEOq">
                        <div class="home_chat-message-top-actions__PfOzb">
                            <div class="home_chat-message-top-action__wXKmA">复制</div>
                        </div>
                        <div class="markdown-body" style="font-size: 14px; height: auto;">
                            <p>${content}</p>
                        </div>
                    </div>
                    <div class="home_chat-message-actions__nrHd1">
                        <div class="home_chat-message-action-date__6ToUp">${time}</div>
                    </div>
                </div>
            </div>
            `;

        chatContent.append(serverMsg);

        // 添加完后滚动到底部
        scrollToBottom();

        copy();
    }


    // 复制功能
    function copy() {
        // 从 chatContent 中获取最后一个 chat-message
        const chatMessage = chatContent.children(".home_chat-message__rdH_g").last();
        console.log("chatContent", chatMessage);
        // 从 chatMessage 找出复制按钮
        const copyBtn = chatMessage.find(".home_chat-message-top-action__wXKmA").get(0);

        const clipboard = new ClipboardJS(copyBtn, {
            text: function(trigger) {
                let copyInput = chatMessage.find('.markdown-body').get(0);
                return copyInput.innerText;
            }
        });

        clipboard.on('success', function(e) {
            // 复制成功
            toastr.info("复制成功");
            e.clearSelection();
        });

        clipboard.on('error', function(e) {
            console.log('复制失败');
        });
    }

    // 添加用户端消息
    function addClientMsg(messageContent) {
        const avatarUrl = user.photo;
        let userMsg = `
            <div class="home_chat-message-user__WsuiB">
                <div class="home_chat-message-container__plj_e">
                    <div class="home_chat-message-avatar__611lI">
                        <div class="user-avatar">
                            <img src="${avatarUrl}" alt="smiley" class="__EmojiPicker__ epr-emoji-img" loading="eager">
                        </div>
                    </div>
                    <div class="home_chat-message-item__hDEOq">
                        <div class="markdown-body" style="font-size: 14px; height: auto;">
                            <p>${messageContent}</p>
                        </div>
                    </div>
                    <div class="home_chat-message-actions__loading">
                        <div class="home_chat-message-action-loading__6ToUp">
                            <div class="lds-ellipsis">
                                <div></div>
                                <div></div>
                                <div></div>
                                <div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            `;


        chatContent.append(userMsg);
        // 添加完后滚动到底部
        scrollToBottom();
    }

    // 滚动到底部
    function scrollToBottom() {
        $(".chat-display").scrollTop(chatContent[0].scrollHeight);
    }

    function doSend() {
        if (ws.readyState === WebSocket.OPEN) {
            const qa = inputField.val();
            ws.send(qa);
            // 清空 textarea
            inputField.val("");

            addClientMsg(qa);

            // 将 button 设为禁用，防止用户连续点击
            sendBtn.attr("disabled", true);
        } else if (ws.readyState === WebSocket.CONNECTING) {
            // depending on your use case. I believe in you developer!
            ws.addEventListener('open', () => doSend())
        }
    }


    sendBtn.click(function () {
        if (ws == null || ws.readyState === WebSocket.CLOSED || ws.readyState === WebSocket.CLOSING) {
            initWs();
        } else {
            // 如果消息内容为空的时候重新聚焦到输入框
            if (inputField.val() === "") {
                inputField.focus();
            } else {
                // 发送消息
                doSend();
            }
        }
    });

    inputField.keydown(function (e) {
        if (e.keyCode === 13) {
            // 按下回车的时候调用 sendbtn 的 click 事件
            sendBtn.click();
            // 阻止默认行为
            e.preventDefault();
        }
    });
</script>
</html>
