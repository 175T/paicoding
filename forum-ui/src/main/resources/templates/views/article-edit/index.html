<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
  <div th:replace="components/layout/header :: head(~{::title}, ~{}, ~{})">
    <title th:text="${global.siteInfo.websiteName}">技术派 - 文章发表</title>
  </div>

  <link rel="stylesheet" href="/css/views/article-edit.css" />

  <body id="body">
    <!-- 正文内容 -->
    <div class="edit-nav">
      <form action="/save" method="get" class="edit-title-form">
        <input
          id="title"
          type="text"
          class="edit-title-input"
          th:value="${vo.article != null ? vo.article.title: ''}"
          placeholder="输入文章标题..."
          oninput="checkTitle()"
        />
      </form>
      <div class="edit-save" data-toggle="modal" data-target="#saveModel">
        <span>保 存</span>
      </div>
      <div class="dropdown">
        <img
          class="nav-login-img dropdown-toggle"
          data-toggle="dropdown"
          th:src="${global.user.photo}"
        />
        <!-- 下拉框 -->
        <div class="dropdown-menu nav-login-menu">
          <div
            th:if="${#strings.equalsIgnoreCase(global.user.role, 'admin')}"
            class="dropdown-divider"
          ></div>
          <a
            th:href="${'/user/home?userId=' + global.user.userId}"
            class="dropdown-item"
            href="#"
          >
            个人主页
          </a>
          <a id="logoutBtn" href="/logout" class="dropdown-item">登出</a>
        </div>
      </div>
    </div>
    <input
      type="hidden"
      id="articleId"
      th:value="${vo.article != null ? vo.article.articleId: ''}"
    />
    <div class="form-group" id="paiEditor">
      <textarea
        style="display: none"
        th:text="${vo.article != null ? vo.article.content: ''}"
      ></textarea>
    </div>

    <div
      class="modal fade"
      id="saveModel"
      role="dialog"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">发布文章</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="edit-sort-wrap form-group category required">
              <label class="form-label">分类:</label>
              <div class="form-selectgroup">
                <label
                  th:each="category : ${vo.categories}"
                  th:class="'form-selectgroup-item ' + ${category.selected ? 'form-selectgroup-item--active': ''}"
                >
                  <input
                    type="radio"
                    name="category"
                    th:value="${category.categoryId}"
                    th:checked="${category.selected}"
                    class="form-selectgroup-input"
                  />
                  <span
                    class="form-selectgroup-label"
                    th:text="${category.category}"
                  >
                    后端
                  </span>
                </label>
              </div>
            </div>

            <div class="form-group edit-tag-wrap required">
              <label class="form-label">添加标签:</label>
              <select id="tag-select" class="form-control" multiple="multiple">
                <option
                  th:each="tag : ${vo.tags}"
                  th:text="${tag.tag}"
                  th:value="${tag.tagId}"
                  selected="selected"
                ></option>
              </select>
            </div>

            <div class="input-group cover">
              <label class="form-label">文章封面:</label>
              <div class="custom-file">
                <div class="person-img-inter-wrap">
                  <div class="click-cover">
                    <svg
                      t="1670660402857"
                      class="icon"
                      viewBox="0 0 1024 1024"
                      version="1.1"
                      xmlns="http://www.w3.org/2000/svg"
                      p-id="2974"
                      width="16"
                      height="16"
                    >
                      <path
                        d="M782.72512 327.9104l-242.54464-242.54464a35.84512 35.84512 0 0 0-13.76256-10.7008c-0.22016-0.09728-0.44032-0.2048-0.67072-0.30208a33.97632 33.97632 0 0 0-13.34272-2.73408l-0.08704 0.00512-0.32256-0.01536c-0.09216 0-0.1792 0.01536-0.27136 0.01536-0.09728 0-0.18944-0.01536-0.2816-0.01536a33.7664 33.7664 0 0 0-20.21376 6.66624 35.96288 35.96288 0 0 0-6.79936 6.27712l-243.3536 243.36384c-6.97856 6.97856-10.85952 15.97952-11.0848 25.4208a35.4304 35.4304 0 0 0 9.3696 24.9344l0.512 0.512a34.49344 34.49344 0 0 0 24.01792 9.57952 36.5568 36.5568 0 0 0 26.33728-11.29472L476.16 191.14496v499.99872a35.84 35.84 0 1 0 71.68 0v-499.8144l185.73312 185.73312c6.97856 6.97856 15.97952 10.85952 25.41568 11.0848l0.86016 0.01024c9.1136 0 17.60768-3.43552 24.07936-9.37984l0.512-0.512c13.30176-13.83424 12.76928-36.38272-1.7152-50.3552z"
                        fill="#ffffff"
                        p-id="2975"
                      ></path>
                      <path
                        d="M880.64 747.57632v61.44c0 39.58784-32.09216 71.68-71.68 71.68H215.04c-39.58784 0-71.68-32.09216-71.68-71.68v-61.44a35.84 35.84 0 1 0-71.68 0v61.44c0 79.17568 64.18432 143.36 143.36 143.36h593.92c79.17568 0 143.36-64.18432 143.36-143.36v-61.44a35.84 35.84 0 1 0-71.68 0z"
                        fill="#ffffff"
                        p-id="2976"
                      ></path>
                    </svg>
                    <div class="click-text">点击上传封面</div>
                  </div>
                  <img
                    class="person-img"
                    id="pic"
                    th:src="${vo.article != null ? vo.article.cover: ''}"
                  />
                  <span class="close_icon">X</span>

                  <svg
                    t="1670660844412"
                    class="upload-icon-up"
                    viewBox="0 0 1029 1024"
                    version="1.1"
                    xmlns="http://www.w3.org/2000/svg"
                    p-id="3248"
                    width="24"
                    height="24"
                  >
                    <path
                      d="M661.23 1003.042H119.672c-64.034 0-116.053-51.883-116.053-115.712V115.917C3.618 52.224 55.638 0.068 119.671 0.068H893.27c63.898 0 115.985 52.02 115.985 115.849v539.99c0 21.23-17.34 38.775-38.707 38.775s-38.912-17.34-38.912-38.776v-539.99c0-21.23-17.34-38.638-38.57-38.638H119.67c-21.299 0-38.912 17.408-38.912 38.639v771.14c0 21.231 17.613 38.639 38.912 38.639h541.492c21.162 0 38.707 17.203 38.707 38.639 0.068 21.3-17.545 38.707-38.64 38.707z"
                      fill="#bfbfbf"
                      p-id="3249"
                    ></path>
                    <path
                      d="M42.325 771.755c-9.762 0-19.729-4.028-27.238-11.606-14.95-14.95-14.95-39.458 0-54.408l192.785-192.034c35.157-35.158 89.156-44.169 133.803-21.777L551.39 596.65c14.814 7.578 32.768 4.643 44.373-7.167l347.614-346.317c14.95-15.019 39.458-15.019 54.682 0 15.223 14.882 15.087 39.39 0 54.545l-347.75 346.317c-35.09 35.089-88.816 43.759-133.667 21.367L306.86 561.084c-14.95-7.578-32.7-4.506-44.374 7.168L69.7 760.012c-7.51 7.578-17.34 11.743-27.375 11.743zM351.71 385.775c-63.898 0-116.053-51.746-116.053-115.712 0-63.898 51.882-115.712 116.053-115.712 63.76 0 116.053 51.883 116.053 115.712 0 63.898-52.36 115.712-116.053 115.712z m0-154.146c-21.163 0-38.776 17.271-38.776 38.502 0 21.368 17.477 38.64 38.776 38.64 21.163 0 38.639-17.272 38.639-38.64 0-21.23-17.34-38.502-38.64-38.502zM834.833 1024c-21.367 0-38.844-17.203-38.844-38.775V753.869c0-21.095 17.204-38.64 38.844-38.64 21.163 0 38.776 17.34 38.776 38.64v231.356c-0.069 21.572-17.545 38.775-38.776 38.775z"
                      fill="#bfbfbf"
                      p-id="3250"
                    ></path>
                    <path
                      d="M989.389 868.284c-9.49 0-18.978-3.345-26.76-10.377l-127.864-120.15-128.478 120.15c-15.36 14.404-39.8 13.858-54.409-1.57-14.677-15.633-13.994-39.868 1.707-54.682L788.89 674.611c11.127-13.721 27.58-21.436 45.533-21.436 17.818 0 34.27 7.988 45.261 21.436l135.441 127.044c15.702 14.814 16.52 38.912 1.775 54.682-6.758 7.782-17.066 11.947-27.511 11.947z"
                      fill="#bfbfbf"
                      p-id="3251"
                    ></path>
                  </svg>
                  <input
                    type="file"
                    accept="image/*"
                    id="upload"
                    class="click-input"
                  />
                </div>
              </div>
            </div>
            <div class="input-group input-textarea required">
              <label class="form-label">文章摘要:</label>
              <textarea
                id="summary"
                class="form-control form-textarea summary"
                data-bs-toggle="autosize"
                placeholder="摘要（必填）：会在推荐、列表等场景外露，帮助读者快速了解内容，支持一键将正文前 128 字符键入摘要文本框"
                maxlength="128"
                th:text="${vo.article != null ?  vo.article.summary: ''}"
                oninput="checkArea()"
              ></textarea>
              <span
                class="form-textarea-limit"
                th:text="${vo.article != null ?  #strings.length(vo.article.summary) + '/128': '0/128'}"
              >
                0/128
              </span>
              <button
                type="button"
                class="el-button btn-getdistill el-button--default el-button--mini is-round"
              >
                <span>一键提取</span>
              </button>
            </div>
          </div>
          <div class="modal-footer">
            <button id="publish" type="button" class="btn btn-primary">
              发布
            </button>
            <button id="tmpSave" type="button" class="btn btn-secondary">
              存草稿
            </button>
          </div>
        </div>
      </div>
    </div>

    <script th:inline="javascript">
      // https://github.com/sparksuite/simplemde-markdown-editor
      let vo = [[${ vo }]], uid = "forumId", articleId = 0;
      if (vo && vo.article) {
        articleId = vo.article.articleId;
        uid = uid + "_" + articleId;
      }

      // $.get('/article/api/content?articleId=' + articleId, function(md){
      var simplemde = editormd("paiEditor", {
        width: "100%",
        // height: 740,
        path: '../editormd/lib/',
        // autoHeight : true,
        // theme : "dark",
        // previewTheme : "dark",
        // editorTheme : "pastel-on-dark",
        // markdown : md.result,
        codeFold: true,
        //syncScrolling : false,
        saveHTMLToTextarea: true,    // 保存 HTML 到 Textarea
        searchReplace: true,
        //watch : false,                // 关闭实时预览
        htmlDecode: "style,script,iframe|on*",            // 开启 HTML 标签解析，为了安全性，默认不开启
        //toolbar  : false,             //关闭工具栏
        //previewCodeHighlight : false, // 关闭预览 HTML 的代码块高亮，默认开启
        emoji: true,
        taskList: true,
        tocm: true,         // Using [TOCM]
        tex: true,                   // 开启科学公式TeX语言支持，默认关闭
        flowChart: true,             // 开启流程图支持，默认关闭
        sequenceDiagram: true,       // 开启时序/序列图支持，默认关闭,
        //dialogLockScreen : false,   // 设置弹出层对话框不锁屏，全局通用，默认为true
        //dialogShowMask : false,     // 设置弹出层对话框显示透明遮罩层，全局通用，默认为true
        //dialogDraggable : false,    // 设置弹出层对话框不可拖动，全局通用，默认为true
        //dialogMaskOpacity : 0.4,    // 设置透明遮罩层的透明度，全局通用，默认值为0.1
        //dialogMaskBgColor : "#000", // 设置透明遮罩层的背景颜色，全局通用，默认为#fff
        imageUpload: true,
        imageFormats: ["jpg", "jpeg", "gif", "png", "bmp", "webp"],
        imageUploadURL: "/image/upload",
        onload: function () {
          console.log('onload', this);
          //this.fullscreen();
          //this.unwatch();
          //this.watch().fullscreen();

          //this.setMarkdown("#PHP");
          //this.width("100%");
          //this.height(480);
          //this.resize("100%", 640);
        }
      });
      // });

      $('#tag-select').select2({
        placeholder: '请选择你需要的标签，最多三个', // 提示
        width: '70%', // 宽度
        allowClear: true, // 可清空
        debug: true, // 上线后关闭
        language: 'zh-CN', // 中文
        maximumSelectionLength: 3, //最多选三个
        multiple: true, // 可多选
        // 动态请求数据
        ajax: {
          url: '/article/api/tag/list',
          data: function (params) {
            var query = {
              pageNumber: params.page,
              pageSize: 10,
              key: params.term,
              categoryId: getChooseCategoryId(),
            }

            // 查询参数将是 ?search=[term]&type=public
            return query;
          },
          dataType: 'json',
          processResults: function (response, params) {
            console.log("response: ", response)
            console.log("page: ", params.page)
            var data = $.map(response.result.list, function (obj) {
              obj.id = obj.id || obj.tagId;
              obj.text = obj.text || obj.tag;// 用您的标识符替换pk

              return obj;
            });
            return {
              results: data,
              pagination: {
                more: response.result.pageNum < response.result.pageTotal// 总页数为10，那么1-9页的时候都可以下拉刷新
              }
            };
          }
        }
      });

      // 改成作者自己主动提取，从后台调用，删掉之前的自动提取

      // 提取简介
      $(".btn-getdistill").on("click", function () {
        // 获取文章内容
        var content = simplemde.getMarkdown().trim();
        // 准备提交到后端
        if (content.length <= 6) {
          toastr.error("文章内容太短了！");
          return;
        } else if (content.length > 600) {
          content = content.substring(0, 600)
        }

        const params = {
          content: content,
        };

        post("/article/api/generateSummary", params, function (data) {
          console.log("提取后的简介:", data)
          $("#summary").val(data);
          $('.form-textarea-limit').text(data.length + '/128')
        });

      });

      //  发表文章
      $("#publish").on("click", function () {
        doPostArticle("post")
        // localStorage.removeItem('articleTitle');
      })
      // 保存草稿
      $("#tmpSave").on("click", function () {
        doPostArticle("save")
      })
      // 封面
      let cover = [[${ vo.article != null ? vo.article.cover : '' }]];
      let newCover = "";

      // 获取表单类容
      function doPostArticle(action) {
        const title = $("#title").val();
        const subTitle = $("#subTitle").val();
        const content = simplemde.getMarkdown();
        if (title.length <= 5) {
          toastr.error("文章标题太短!")
          return;
        }
        if (title.length > 120) {
          toastr.error("文章标题太长了!");
          return;
        }
        if (content.length <= 6) {
          toastr.error("文章内容太短了！");
          return;
        }

        // 分类选择
        const category = getChooseCategoryId()
        if (parseInt(category) <= 0) {
          toastr.error("请选择文章分类");
          return;
        }
        // 处理标签
        const tagsAll = [];
        $.each($('#tag-select').select2('data'), function (index, value) {
          tagsAll.push(value.id);
        });

        if (tagsAll.length <= 0 || tagsAll.length > 3) {
          toastr.error("请选择1-3个标签!");
          return;
        }

        const summary = $("#summary").val()
        if (summary.length < 6 || summary.length > 128) {
          toastr.error("简介字数应该在6-128之间哦!");
          return;
        }

        const params = {
          articleId: articleId,
          title: title,
          subTitle: subTitle,
          content: content,
          categoryId: category,
          tagIds: tagsAll,
          summary: summary,
          articleType: "BLOG",
          source: 2,
          sourceUrl: "",
          actionType: action, // post 表示发表, save表示暂存
          cover: cover,
        }
        if (newCover.length > 0) {
          params['cover'] = newCover;
        }
        console.log(params);
        post("/article/api/post", params, function (data) {
          console.log("返回结果:", data)
          window.location.href = "/article/detail/" + data
        })
      }

      function getChooseCategoryId() {
        const category = $("input[name='category']:radio:checked")
        if (category.length > 0) {
          return category.val()
        }
        return -1
      }

      // 检查输入内容的长度
      function checkArea() {
        len = $('#summary').val().length
        if (len > 128) {
          len = 128;
        }
        $('.form-textarea-limit').text(len + '/128')
      }

      // 控制文章分类的选择
      $('.form-selectgroup-item').each(function (index) {
        (function (index) {
          $('.form-selectgroup-item').eq(index).on('click', function () {
            $('.form-selectgroup-item').removeClass('form-selectgroup-item--active')
              .eq(index).addClass('form-selectgroup-item--active')
          })
        })(index)
      })

      let showSaveBtn = false;
      // 处理按钮隐藏时不可编辑
      $('.edit-save').click(() => {
        if (!showSaveBtn) return false
      })
      // 处理title输入保存以及按钮显隐的问题
      const checkTitle = () => {
        const value = $('#title').val()
        const len = value.length
        console.log(value)
        // localStorage.setItem('articleTitle', value)
        if (len > 5) {
          $('.edit-save').addClass('edit-save--active')
          showSaveBtn = true
        } else {
          $('.edit-save').removeClass('edit-save--active')
          showSaveBtn = false
        }
      }
      // 初始化title 暂时去掉缓存
      const initTitle = () => {
        // console.log("init title!");
        // const titleValue = localStorage.getItem('articleTitle')
        // if (titleValue) {
        //   $('#title').attr("value", titleValue)
        //   checkTitle();
        // } else {
        checkTitle()
        // }
      }
      // 初始化标题
      initTitle();


      // 初始化封面
      initCover();

      function initCover() {
        var objUrl = $("#pic").attr("src");
        // 已经上传过了
        if (objUrl) {
          $(".close_icon").css('display', 'block');
          $('.upload-icon-up').css('visibility', 'hidden');
        } else {
          $(".click-cover").css("visibility", "visible")
        }
      }


      // 封面上传相关
      $(".custom-file").on("mouseover", ".person-img-inter-wrap", function () {
        console.log("出现上传的按钮")
        initCover();
      }).on("mouseleave", ".person-img-inter-wrap", function () {
        $(".click-cover").css("visibility", "hidden")
      })

      $(".click-cover").click(function () {
        $("#upload").click() //隐藏了input:file样式后，点击头像就可以本地上传
      })

      $("#upload").on("change", function (e) {
        var objUrl = getObjectURL(this.files[0]) //获取图片的路径，该路径不是图片在本地的路径
        const file = e.target.files[0]
        if (file.size > 1024 * 1024 * 5) {
          toastr.error("图片不能超过5M!")
          return false
        }
        if (objUrl) {
          //将图片路径存入src中，显示出图片
          $("#pic").attr("src", objUrl).css('visibility', 'visible') // 展示图片
          $('.upload-icon-up').css('visibility', 'hidden') // 隐藏上传

          console.log("uploadImg", this.value)
          uploadImg(() => (this.value = null))
        }
      })

      // 删除图片后
      $(".close_icon").click(function () {
        $("#pic").attr("src", "").css('visibility', 'hidden');
        $(".close_icon").css('display', 'none');
        $('.upload-icon-up').css('visibility', 'visible');

        // 删除图片后置空
        newCover = '';
      })

      // 上传头图到服务器
      function uploadImg(callback) {
        var pic = $("#upload")[0].files[0]
        console.log("准备上传", pic)

        var file = new FormData()
        file.append("image", pic)
        $.ajax({
          url: "/image/upload",
          type: "post",
          data: file,
          cache: false,
          contentType: false,
          processData: false,
          success: function (data) {
            const {
              result: { imagePath },
            } = data || {}
            var res = data
            console.log(res, imagePath)
            newCover = imagePath
            // 替换掉默认图片@yihui
            $(".res-upload-img").attr("src", imagePath)
            $(".res-upload-wrap").removeClass("hide")
            callback()
            toastr.info("图片上传成功!")
          },
        })
      }
    </script>
  </body>
</html>
